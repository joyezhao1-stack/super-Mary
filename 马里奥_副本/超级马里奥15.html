<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¶…çº§é©¬åŠ›ï¼Horse å‘ç”Ÿ</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: "Microsoft YaHei", sans-serif; }
        #game-container { position: relative; width: 800px; height: 600px; margin: 20px auto; background: #5c94fc; border: 4px solid #fff; overflow: hidden; }
        canvas { display: block; }
        
        /* ç§»åŠ¨ç«¯æ§åˆ¶æŒ‰é’® */
        .controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 10; }
        .btn { width: 60px; height: 60px; background: rgba(255,255,255,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; user-select: none; }
        
        /* ç»“ç®—ç•Œé¢ */
        #end-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: none; flex-direction: column; 
            align-items: center; justify-content: center; color: #fff; z-index: 20; 
        }
        .victory-text { font-size: 32px; color: #ffcc00; text-align: center; line-height: 1.6; }
        
        /* éŸ³ä¹æ§åˆ¶æŒ‰é’® */
        #music-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            z-index: 30;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div class="controls">
        <div class="btn" id="btn-left">â†</div>
        <div class="btn" id="btn-up">è·³</div>
        <div class="btn" id="btn-right">â†’</div>
    </div>
    
    <div id="music-toggle">ğŸµ</div>

    <div id="end-screen">
        <div class="victory-text">
            æ­å–œï¼2026å¹´<br>
            <span style="font-size: 48px;">è¶…çº§é©¬åŠ›<br>Horse å‘ç”Ÿ</span><br>
            <p style="font-size: 18px;">ç‰©èµ„å…¨æœé›†ï¼å¤§å‰å¤§åˆ©ï¼</p>
            <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px;">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>
</div>

<script>
/**
 * æ¸¸æˆæ ¸å¿ƒé€»è¾‘
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800;
canvas.height = 600;

// åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

// éŸ³é¢‘èŠ‚ç‚¹
let bgmSource = null;
let isMusicPlaying = true;

// èƒŒæ™¯éŸ³ä¹ - ä½¿ç”¨è¶…çº§é©¬é‡Œå¥¥çš„ç»å…¸æ—‹å¾‹
function playBackgroundMusic() {
    if (!isMusicPlaying) return;
    
    // åˆ›å»ºæŒ¯è¡å™¨èŠ‚ç‚¹
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    // è¿æ¥åˆ°éŸ³é¢‘è¾“å‡º
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // è®¾ç½®éŸ³é‡
    gainNode.gain.value = 0.1; // 10% éŸ³é‡
    
    // è¶…çº§é©¬é‡Œå¥¥ç»å…¸æ—‹å¾‹çš„ç®€å•ç‰ˆæœ¬
    const melody = [
        { freq: 523.25, duration: 0.2 }, // C5
        { freq: 659.25, duration: 0.2 }, // E5
        { freq: 783.99, duration: 0.2 }, // G5
        { freq: 659.25, duration: 0.2 }, // E5
        { freq: 783.99, duration: 0.2 }, // G5
        { freq: 880.00, duration: 0.2 }, // A5
        { freq: 987.77, duration: 0.2 }, // B5
        { freq: 880.00, duration: 0.2 }, // A5
        { freq: 783.99, duration: 0.2 }, // G5
        { freq: 659.25, duration: 0.2 }, // E5
        { freq: 523.25, duration: 0.2 }, // C5
        { freq: 392.00, duration: 0.4 }, // G4
    ];
    
    let currentTime = audioContext.currentTime;
    
    // æ’­æ”¾æ—‹å¾‹
    melody.forEach((note, index) => {
        oscillator.frequency.setValueAtTime(note.freq, currentTime);
        currentTime += note.duration;
    });
    
    // è®¾ç½®å¾ªç¯
    oscillator.start();
    oscillator.stop(currentTime);
    
    // ä¿å­˜æºä»¥ä¾¿åç»­æ§åˆ¶
    bgmSource = oscillator;
    
    // å¾ªç¯æ’­æ”¾
    setTimeout(() => {
        if (isMusicPlaying) {
            playBackgroundMusic();
        }
    }, currentTime * 1000);
}

// ç¢°æ’éŸ³æ•ˆ
function playCollisionSound() {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // è®¾ç½®éŸ³æ•ˆ
    gainNode.gain.value = 0.2;
    
    // æœ‰è¶£çš„"ç °"å£°
    oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.1);
    
    // éŸ³é‡è¡°å‡
    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.2);
}

// è·³è·ƒéŸ³æ•ˆ
function playJumpSound() {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // è®¾ç½®éŸ³æ•ˆ
    gainNode.gain.value = 0.15;
    
    // è·³è·ƒéŸ³æ•ˆ - å¿«é€Ÿä¸Šå‡çš„éŸ³è°ƒ
    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
    oscillator.frequency.linearRampToValueAtTime(400, audioContext.currentTime + 0.1);
    
    // éŸ³é‡è¡°å‡
    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.15);
}

// é‡‘å¸æ”¶é›†éŸ³æ•ˆ
function playCoinSound() {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // è®¾ç½®éŸ³æ•ˆ
    gainNode.gain.value = 0.1;
    
    // é‡‘å¸æ”¶é›†çš„æ¸…è„†å£°éŸ³
    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
    
    // éŸ³é‡è¡°å‡
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.2);
}

// éŸ³ä¹åˆ‡æ¢åŠŸèƒ½
document.getElementById('music-toggle').addEventListener('click', function() {
    isMusicPlaying = !isMusicPlaying;
    this.textContent = isMusicPlaying ? 'ğŸµ' : 'ğŸ”‡';
    
    if (isMusicPlaying) {
        playBackgroundMusic();
    }
});

// åŠ è½½ä¸»è§’å›¾ç‰‡ - æ”¹ä¸ºåŒæ–‡ä»¶å¤¹ä¸‹çš„ horse.png
let horseImg = new Image();
horseImg.src = 'horse.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ horse.png å›¾ç‰‡

// åŠ è½½ç –å—å›¾ç‰‡ - æ·»åŠ zhuankuai.pngå›¾ç‰‡
let brickImg = new Image();
brickImg.src = 'zhuankuai.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ zhuankuai.png å›¾ç‰‡

// åŠ è½½ç®¡é“å›¾ç‰‡ - æ·»åŠ guandao.pngå›¾ç‰‡
let pipeImg = new Image();
pipeImg.src = 'guandao.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ guandao.png å›¾ç‰‡

// åŠ è½½èƒŒæ™¯å›¾ç‰‡ - æ·»åŠ beijing.pngå›¾ç‰‡
let bgImg = new Image();
bgImg.src = 'beijing.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ beijing.png å›¾ç‰‡

// åŠ è½½äº‘æœµå›¾ç‰‡
let cloud1Img = new Image();
cloud1Img.src = 'yunduo1.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ yunduo1.png å›¾ç‰‡

let cloud2Img = new Image();
cloud2Img.src = 'yunduo2.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ yunduo2.png å›¾ç‰‡

// åŠ è½½è˜‘è‡å›¾ç‰‡ - æ·»åŠ mogu.pngå›¾ç‰‡
let mushroomImg = new Image();
mushroomImg.src = 'mogu.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ mogu.png å›¾ç‰‡

// åŠ è½½é‡‘å¸å›¾ç‰‡ - æ·»åŠ jinbi.pngå›¾ç‰‡
let coinImg = new Image();
coinImg.src = 'jinbi.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ jinbi.png å›¾ç‰‡

// åŠ è½½å‰å­—å›¾ç‰‡ - æ·»åŠ ji.pngå›¾ç‰‡
let jiImg = new Image();
jiImg.src = 'ji.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ ji.png å›¾ç‰‡

// åŠ è½½æ©˜å­å›¾ç‰‡ - æ·»åŠ juzi.pngå›¾ç‰‡
let juziImg = new Image();
juziImg.src = 'juzi.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ juzi.png å›¾ç‰‡

// åŠ è½½ç¦å­—å›¾ç‰‡ - æ·»åŠ fu.pngå›¾ç‰‡
let fuImg = new Image();
fuImg.src = 'fu.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ fu.png å›¾ç‰‡

// åŠ è½½è´¢å­—å›¾ç‰‡ - æ·»åŠ cai.pngå›¾ç‰‡
let caiImg = new Image();
caiImg.src = 'cai.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ cai.png å›¾ç‰‡

// åŠ è½½æ—ºå­—å›¾ç‰‡ - æ·»åŠ wang.pngå›¾ç‰‡
let wangImg = new Image();
wangImg.src = 'wang.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ wang.png å›¾ç‰‡

// åŠ è½½è¿å­—å›¾ç‰‡ - æ·»åŠ yun.pngå›¾ç‰‡
let yunImg = new Image();
yunImg.src = 'yun.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ yun.png å›¾ç‰‡

// åŠ è½½é¡ºå­—å›¾ç‰‡ - æ·»åŠ shun.pngå›¾ç‰‡
let shunImg = new Image();
shunImg.src = 'shun.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ shun.png å›¾ç‰‡

// åŠ è½½å•ä¸ªç –å—å›¾ç‰‡ - æ·»åŠ dangezhuankuai.pngå›¾ç‰‡
let dangezhuankuaiImg = new Image();
dangezhuankuaiImg.src = 'dangezhuankuai.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ dangezhuankuai.png å›¾ç‰‡

// åŠ è½½ç‰©å“å›¾ç‰‡
let hongbaoImg = new Image();
hongbaoImg.src = 'hongbao.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ hongbao.png å›¾ç‰‡

let yuanbaoImg = new Image();
yuanbaoImg.src = 'yuanbao.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ yuanbao.png å›¾ç‰‡

let dogImg = new Image();
dogImg.src = 'dog.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ dog.png å›¾ç‰‡

let yuImg = new Image();
yuImg.src = 'yu.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ yu.png å›¾ç‰‡

let liuliuImg = new Image();
liuliuImg.src = '666.png'; // ä½¿ç”¨åŒæ–‡ä»¶å¤¹ä¸‹çš„ 666.png å›¾ç‰‡

// æ ‡è®°å›¾ç‰‡æ˜¯å¦åŠ è½½æˆåŠŸ
let horseImgLoaded = false;
let brickImgLoaded = false;
let pipeImgLoaded = false;
let bgImgLoaded = false;
let cloud1ImgLoaded = false;
let cloud2ImgLoaded = false;
let mushroomImgLoaded = false;
let coinImgLoaded = false;
let jiImgLoaded = false;
let juziImgLoaded = false;
let fuImgLoaded = false;
let caiImgLoaded = false;
let wangImgLoaded = false;
let yunImgLoaded = false;
let shunImgLoaded = false;
let dangezhuankuaiImgLoaded = false;
let hongbaoImgLoaded = false;
let yuanbaoImgLoaded = false;
let dogImgLoaded = false;
let yuImgLoaded = false;
let liuliuImgLoaded = false;

horseImg.onload = function() {
    horseImgLoaded = true;
    console.log('ä¸»è§’å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
horseImg.onerror = function() {
    console.log('ä¸»è§’å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨å ä½ç¬¦');
};

brickImg.onload = function() {
    brickImgLoaded = true;
    console.log('ç –å—å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
brickImg.onerror = function() {
    console.log('ç –å—å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

pipeImg.onload = function() {
    pipeImgLoaded = true;
    console.log('ç®¡é“å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
pipeImg.onerror = function() {
    console.log('ç®¡é“å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

bgImg.onload = function() {
    bgImgLoaded = true;
    console.log('èƒŒæ™¯å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
bgImg.onerror = function() {
    console.log('èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

cloud1Img.onload = function() {
    cloud1ImgLoaded = true;
    console.log('äº‘æœµ1å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
cloud1Img.onerror = function() {
    console.log('äº‘æœµ1å›¾ç‰‡åŠ è½½å¤±è´¥');
};

cloud2Img.onload = function() {
    cloud2ImgLoaded = true;
    console.log('äº‘æœµ2å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
cloud2Img.onerror = function() {
    console.log('äº‘æœµ2å›¾ç‰‡åŠ è½½å¤±è´¥');
};

mushroomImg.onload = function() {
    mushroomImgLoaded = true;
    console.log('è˜‘è‡å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
mushroomImg.onerror = function() {
    console.log('è˜‘è‡å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

coinImg.onload = function() {
    coinImgLoaded = true;
    console.log('é‡‘å¸å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
coinImg.onerror = function() {
    console.log('é‡‘å¸å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

jiImg.onload = function() {
    jiImgLoaded = true;
    console.log('å‰å­—å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
jiImg.onerror = function() {
    console.log('å‰å­—å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

juziImg.onload = function() {
    juziImgLoaded = true;
    console.log('æ©˜å­å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
juziImg.onerror = function() {
    console.log('æ©˜å­å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨æ–‡å­—æ˜¾ç¤º');
};

fuImg.onload = function() {
    fuImgLoaded = true;
    console.log('ç¦å­—å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
fuImg.onerror = function() {
    console.log('ç¦å­—å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

caiImg.onload = function() {
    caiImgLoaded = true;
    console.log('è´¢å­—å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
caiImg.onerror = function() {
    console.log('è´¢å­—å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

wangImg.onload = function() {
    wangImgLoaded = true;
    console.log('æ—ºå­—å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
wangImg.onerror = function() {
    console.log('æ—ºå­—å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

yunImg.onload = function() {
    yunImgLoaded = true;
    console.log('è¿å­—å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
yunImg.onerror = function() {
    console.log('è¿å­—å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

shunImg.onload = function() {
    shunImgLoaded = true;
    console.log('é¡ºå­—å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
shunImg.onerror = function() {
    console.log('é¡ºå­—å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

dangezhuankuaiImg.onload = function() {
    dangezhuankuaiImgLoaded = true;
    console.log('å•ä¸ªç –å—å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
dangezhuankuaiImg.onerror = function() {
    console.log('å•ä¸ªç –å—å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é¢œè‰²å¡«å……');
};

hongbaoImg.onload = function() {
    hongbaoImgLoaded = true;
    console.log('çº¢åŒ…å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
hongbaoImg.onerror = function() {
    console.log('çº¢åŒ…å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨æ–‡å­—æ˜¾ç¤º');
};

yuanbaoImg.onload = function() {
    yuanbaoImgLoaded = true;
    console.log('å…ƒå®å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
yuanbaoImg.onerror = function() {
    console.log('å…ƒå®å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨æ–‡å­—æ˜¾ç¤º');
};

dogImg.onload = function() {
    dogImgLoaded = true;
    console.log('ç‹—å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
dogImg.onerror = function() {
    console.log('ç‹—å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨æ–‡å­—æ˜¾ç¤º');
};

yuImg.onload = function() {
    yuImgLoaded = true;
    console.log('é±¼å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
yuImg.onerror = function() {
    console.log('é±¼å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨æ–‡å­—æ˜¾ç¤º');
};

liuliuImg.onload = function() {
    liuliuImgLoaded = true;
    console.log('666å›¾ç‰‡åŠ è½½æˆåŠŸ');
};
liuliuImg.onerror = function() {
    console.log('666å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨æ–‡å­—æ˜¾ç¤º');
};

// æ¸¸æˆé…ç½®
const config = {
    gravity: 0.8,
    jumpStrength: -15,
    doubleJumpStrength: -10, // äºŒè¿è·³å¼ºåº¦ï¼Œæ¯”ä¸€æ®µè·³å¼±ä¸€äº›
    speed: 5,
    groundY: 520
};

// åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€å‡½æ•°
function initGame() {
    // é‡ç½®èµ„æºçŠ¶æ€
    inventory = {
        "å‰": false, "ç¦": false, "è´¢": false, "æ—º": false, "è¿": false, "é¡º": false, "coins": 0
    };

    // é‡ç½®ä¸»è§’çŠ¶æ€
    player.x = 50;
    player.y = 600; // åˆå§‹åœ¨æ°´ç®¡ä¸‹
    player.vx = 0;
    player.vy = 0;
    player.isJumping = false;
    player.jumpCount = 0;
    player.canDoubleJump = false;
    player.state = 'entering';
    player.faceRight = true;

    // é‡ç½®ç –å—æ”¶é›†çŠ¶æ€
    blocks.forEach(block => {
        block.collected = false;
    });

    // é‡ç½®é‡‘å¸æ”¶é›†çŠ¶æ€
    coins.forEach(coin => {
        coin.collected = false;
    });

    // é‡ç½®è˜‘è‡ä½ç½®
    enemy.x = 400;
    enemy.y = 490;
    enemy.dir = 1;

    // é‡ç½®äº‘æœµä½ç½®
    clouds[0].x = 100;
    clouds[0].dir = 1;
    clouds[1].x = 600;
    clouds[1].dir = -1;

    // éšè—ç»“æŸç•Œé¢
    document.getElementById('end-screen').style.display = 'none';
    
    // å¼€å§‹æ’­æ”¾èƒŒæ™¯éŸ³ä¹
    playBackgroundMusic();
}

// èµ„æºçŠ¶æ€
let inventory = {
    "å‰": false, "ç¦": false, "è´¢": false, "æ—º": false, "è¿": false, "é¡º": false, "coins": 0
};

// 1. å®šä¹‰ä¸»è§’ (è®¾è®¡ç¨¿ä¸­çš„å°é©¬)
const player = {
    x: 50,
    y: 600, // åˆå§‹åœ¨æ°´ç®¡ä¸‹
    w: 50,
    h: 60,
    vx: 0,
    vy: 0,
    isJumping: false,
    jumpCount: 0, // è·³è·ƒæ¬¡æ•°ï¼Œç”¨äºå®ç°äºŒè¿è·³
    canDoubleJump: false, // æ˜¯å¦å¯ä»¥äºŒè¿è·³
    state: 'entering', // entering, playing, finished
    faceRight: true // æ–°å¢ï¼šæ§åˆ¶å°é©¬æœå‘ï¼Œtrueä¸ºæœå³ï¼Œfalseä¸ºæœå·¦
};

// 2. å®šä¹‰ç –å—ç‰©èµ„åœ°å›¾
const blocks = [
    { x: 100, y: 350, type: 'å‰', item: 'æ©˜å­', collected: false },
    { x: 140, y: 350, type: '', item: '', collected: false }, // ä¸­é—´è¿æ¥è‰²å—ï¼Œæ— å­—æ— ç‰©å“ï¼Œç´§æŒ¨ç€"å‰"å­—ç –å—
    { x: 180, y: 350, type: 'ç¦', item: 'çº¢åŒ…', collected: false }, // ç´§æŒ¨ç€ä¸­é—´è¿æ¥è‰²å—
    
    // "è´¢"å­—ç –å—ã€"æ—º"å­—ç –å—ä»¥åŠä¸­é—´çš„è‰²å—ï¼ˆ3ä¸ªï¼‰ï¼Œæ•´ä½“å‘å·¦ç§»åŠ¨15åƒç´ 
    { x: 375, y: 300, type: 'è´¢', item: 'é‡‘å…ƒå®', collected: false }, // åŸx:390ï¼Œå‘å·¦ç§»åŠ¨15åƒç´ 
    { x: 415, y: 300, type: '', item: '', collected: false }, // ä¸­é—´è¿æ¥è‰²å—ï¼ŒåŸx:430ï¼Œå‘å·¦ç§»åŠ¨15åƒç´ 
    { x: 455, y: 300, type: 'æ—º', item: 'ç‹—', collected: false }, // åŸx:470ï¼Œå‘å·¦ç§»åŠ¨15åƒç´ 
    
    // "è¿"å­—çš„è‰²å—ï¼Œæ•´ä½“å‘å·¦ç§»åŠ¨15åƒç´ 
    { x: 585, y: 250, type: 'è¿', item: 'é±¼', collected: false }, // åŸx:600ï¼Œå‘å·¦ç§»åŠ¨15åƒç´ 
    
    // "é¡º"å­—çš„è‰²å—ä»¥åŠå®ƒä¸¤è¾¹çš„è‰²å—ï¼ˆ3ä¸ªï¼‰ï¼Œæ•´ä½“å‘å·¦ç§»åŠ¨15åƒç´ 
    { x: 665, y: 250, type: '', item: '', collected: false }, // å·¦è¾¹çº¯è‰²å—ï¼ŒåŸx:680ï¼Œå‘å·¦ç§»åŠ¨15åƒç´ 
    { x: 705, y: 250, type: 'é¡º', item: '666', collected: false }, // "é¡º"å­—ç –å—ï¼ŒåŸx:720ï¼Œå‘å·¦ç§»åŠ¨15åƒç´ 
    { x: 745, y: 250, type: '', item: '', collected: false }  // å³è¾¹çº¯è‰²å—ï¼ŒåŸx:760ï¼Œå‘å·¦ç§»åŠ¨15åƒç´ 
];

// 3. å®šä¹‰é‡‘å¸å’Œè˜‘è‡
const coins = [
    { x: 670, y: 460, collected: false },
    { x: 702, y: 420, collected: false },
    { x: 740, y: 380, collected: false }
];

const enemy = { x: 400, y: 490, w: 30, h: 30, speed: 2, dir: 1 };

// 4. å®šä¹‰ä¸¤æœµäº‘
const clouds = [
    { 
        x: 100, // åå·¦ä¾§èµ·å§‹ä½ç½®
        y: 50, // Yåæ ‡è°ƒæ•´ä¸º0
        startX: 100, // èµ·å§‹ä½ç½®
        minX: 87, // æœ€å°Xä½ç½® - èŒƒå›´å‡åŠ
        maxX: 113, // æœ€å¤§Xä½ç½® - èŒƒå›´å‡åŠ
        width: 120, // æ”¾å¤§ä¸ºåŸæœ¬çš„1.5å€ (80 * 1.5 = 120)
        height: 90, // æ”¾å¤§ä¸ºåŸæœ¬çš„1.5å€ (60 * 1.5 = 90)
        speed: 0.1, // ç§»åŠ¨é€Ÿåº¦æ”¹ä¸º0.1åƒç´ æ¯å¸§
        dir: 1, // ç§»åŠ¨æ–¹å‘ï¼š1å‘å³ï¼Œ-1å‘å·¦
        type: 1 // äº‘æœµç±»å‹ï¼š1è¡¨ç¤ºyunduo1.png
    },
    { 
        x: 600, // åå³ä¾§èµ·å§‹ä½ç½®
        y: 100, // Yåæ ‡è°ƒæ•´ä¸º100
        startX: 600, // èµ·å§‹ä½ç½®
        minX: 587, // æœ€å°Xä½ç½® - èŒƒå›´å‡åŠ
        maxX: 613, // æœ€å¤§Xä½ç½® - èŒƒå›´å‡åŠ
        width: 120, // æ”¾å¤§ä¸ºåŸæœ¬çš„1.5å€ (100 * 1.2 = 120)
        height: 84, // æ”¾å¤§ä¸ºåŸæœ¬çš„1.2å€ (70 * 1.2 = 84)
        speed: 0.1, // ç§»åŠ¨é€Ÿåº¦æ”¹ä¸º0.1åƒç´ æ¯å¸§
        dir: -1, // ç§»åŠ¨æ–¹å‘ï¼š-1å‘å·¦
        type: 2 // äº‘æœµç±»å‹ï¼š2è¡¨ç¤ºyunduo2.png
    }
];

// æ£€æµ‹çŸ©å½¢ç¢°æ’å‡½æ•°
function checkCollision(rect1, rect2) {
    return rect1.x < rect2.x + rect2.w &&
           rect1.x + rect1.w > rect2.x &&
           rect1.y < rect2.y + rect2.h &&
           rect1.y + rect1.h > rect2.y;
}

// åŠ¨ç”»ï¼šæ°´ç®¡æ»‘å‡º
function pipeAnimation() {
    if (player.state === 'entering') {
        player.y -= 2;
        if (player.y <= config.groundY - player.h) {
            player.state = 'playing';
        }
    }
}

// æ›´æ–°äº‘æœµä½ç½®
function updateClouds() {
    clouds.forEach(cloud => {
        // æ›´æ–°äº‘æœµä½ç½®
        cloud.x += cloud.speed * cloud.dir;
        
        // è¾¹ç•Œæ£€æµ‹ï¼Œè®©äº‘æœµåœ¨å°èŒƒå›´å†…æ¥å›ç§»åŠ¨
        if (cloud.x > cloud.maxX) {
            cloud.x = cloud.maxX;
            cloud.dir = -1; // å‘å³ç§»åŠ¨åˆ°è¾¹ç•Œåæ”¹ä¸ºå‘å·¦ç§»åŠ¨
        } else if (cloud.x < cloud.minX) {
            cloud.x = cloud.minX;
            cloud.dir = 1; // å‘å·¦ç§»åŠ¨åˆ°è¾¹ç•Œåæ”¹ä¸ºå‘å³ç§»åŠ¨
        }
    });
}

// æ ¸å¿ƒæ›´æ–°é€»è¾‘
function update() {
    if (player.state === 'entering') {
        pipeAnimation();
        return;
    }

    if (player.state === 'finished') return;

    // æ›´æ–°äº‘æœµä½ç½®
    updateClouds();

    // ç‰©ç†è¿åŠ¨
    player.vy += config.gravity;
    player.y += player.vy;
    player.x += player.vx;

    // åœ°é¢æ£€æµ‹
    if (player.y > config.groundY - player.h) {
        player.y = config.groundY - player.h;
        player.vy = 0;
        player.isJumping = false;
        player.jumpCount = 0; // è½åœ°åé‡ç½®è·³è·ƒæ¬¡æ•°
        player.canDoubleJump = false; // è½åœ°åä¸èƒ½äºŒè¿è·³
    }

    // ç¢°æ’ç –å—æ£€æµ‹ (å¤´é¡¶æ’å‡»)
    let hitBrick = false;
    blocks.forEach(b => {
        if (!b.collected && 
            player.x + player.w > b.x && player.x < b.x + 40 &&
            player.vy < 0 && 
            player.y < b.y + 40 && player.y > b.y) {
                b.collected = true;
                // åªæœ‰æœ‰typeçš„ç –å—æ‰æ·»åŠ åˆ°inventory
                if (b.type) {
                    inventory[b.type] = true;
                }
                player.vy = 2; // æ’å‡»å›å¼¹
                checkWinCondition();
                hitBrick = true;
        }
    });
    
    // å¦‚æœç¢°åˆ°äº†ç –å—ï¼Œæ’­æ”¾ç¢°æ’éŸ³æ•ˆ
    if (hitBrick) {
        playCollisionSound();
    }

    // ç¢°æ’é‡‘å¸æ£€æµ‹
    coins.forEach(c => {
        if (!c.collected && 
            Math.hypot(player.x - c.x, player.y - c.y) < 30) {
            c.collected = true;
            inventory.coins++;
            checkWinCondition();
            playCoinSound(); // æ’­æ”¾é‡‘å¸æ”¶é›†éŸ³æ•ˆ
        }
    });

    // è˜‘è‡ç§»åŠ¨ä¸ç¢°æ’
    enemy.x += enemy.speed * enemy.dir;
    if (enemy.x > 600 || enemy.x < 300) enemy.dir *= -1;
    
    // æ£€æµ‹å°é©¬æ˜¯å¦ç¢°åˆ°è˜‘è‡ - ä½¿ç”¨çŸ©å½¢ç¢°æ’æ£€æµ‹
    if (checkCollision(player, enemy)) {
        // ç¢°åˆ°è˜‘è‡ï¼Œæ’­æ”¾ç¢°æ’éŸ³æ•ˆ
        playCollisionSound();
        // çŸ­æš‚å»¶è¿Ÿåé‡æ–°å¼€å§‹æ¸¸æˆ
        setTimeout(() => {
            initGame();
        }, 300);
        return;
    }
}

function checkWinCondition() {
    // åªæ£€æŸ¥æœ‰typeçš„ç –å—
    const allItems = blocks.filter(b => b.type).every(b => b.collected);
    if (allItems && inventory.coins >= 3) {
        player.state = 'finished';
        document.getElementById('end-screen').style.display = 'flex';
    }
}

// è·³è·ƒå‡½æ•°
function jump() {
    // å¦‚æœåœ¨åœ°é¢ä¸Šï¼Œè¿›è¡Œç¬¬ä¸€æ¬¡è·³è·ƒ
    if (player.jumpCount === 0 && !player.isJumping) {
        player.vy = config.jumpStrength;
        player.isJumping = true;
        player.jumpCount = 1;
        player.canDoubleJump = true; // ç¬¬ä¸€æ¬¡è·³è·ƒåå¯ä»¥äºŒè¿è·³
        playJumpSound(); // æ’­æ”¾è·³è·ƒéŸ³æ•ˆ
        return true;
    }
    // å¦‚æœåœ¨ç©ºä¸­ä¸”å¯ä»¥äºŒè¿è·³ï¼Œè¿›è¡Œç¬¬äºŒæ¬¡è·³è·ƒ
    else if (player.canDoubleJump && player.jumpCount === 1) {
        player.vy = config.doubleJumpStrength;
        player.jumpCount = 2;
        player.canDoubleJump = false; // äºŒè¿è·³åä¸èƒ½å†è·³
        playJumpSound(); // æ’­æ”¾è·³è·ƒéŸ³æ•ˆ
        return true;
    }
    return false;
}

// ç»˜åˆ¶äº‘æœµ
function drawClouds() {
    clouds.forEach(cloud => {
        if (cloud.type === 1 && cloud1ImgLoaded) {
            // ç»˜åˆ¶ç¬¬ä¸€æœµäº‘
            ctx.drawImage(cloud1Img, cloud.x, cloud.y, cloud.width, cloud.height);
        } else if (cloud.type === 2 && cloud2ImgLoaded) {
            // ç»˜åˆ¶ç¬¬äºŒæœµäº‘
            ctx.drawImage(cloud2Img, cloud.x, cloud.y, cloud.width, cloud.height);
        } else {
            // å¦‚æœå›¾ç‰‡æœªåŠ è½½ï¼Œä½¿ç”¨ç®€å•çš„åœ†å½¢ä½œä¸ºå ä½ç¬¦
            ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
            ctx.beginPath();
            ctx.ellipse(cloud.x + cloud.width/2, cloud.y + cloud.height/2, cloud.width/2, cloud.height/2, 0, 0, Math.PI * 2);
            ctx.fill();
        }
    });
}

// ç»˜åˆ¶ä¸»è§’ï¼ˆå¸¦åè½¬åŠŸèƒ½ï¼‰
function drawPlayer() {
    if (horseImgLoaded) {
        // ä¿å­˜å½“å‰ä¸Šä¸‹æ–‡çŠ¶æ€
        ctx.save();
        
        // å¦‚æœå°é©¬æœå·¦ï¼Œåˆ™è¿›è¡Œæ°´å¹³ç¿»è½¬
        if (!player.faceRight) {
            // å…ˆå¹³ç§»åˆ°å°é©¬ä¸­å¿ƒï¼Œç„¶åæ°´å¹³ç¿»è½¬ï¼Œå†å¹³ç§»å›æ¥
            ctx.translate(player.x + player.w/2, player.y + player.h/2);
            ctx.scale(-1, 1); // æ°´å¹³ç¿»è½¬
            ctx.translate(-(player.x + player.w/2), -(player.y + player.h/2));
        }
        
        // ç»˜åˆ¶å°é©¬å›¾ç‰‡
        ctx.drawImage(horseImg, player.x, player.y, player.w, player.h);
        
        // æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€
        ctx.restore();
    } else {
        // å¦‚æœå›¾ç‰‡æœªåŠ è½½ï¼Œä½¿ç”¨åŸæ¥çš„ç»˜åˆ¶æ–¹æ³•
        ctx.fillStyle = "#fff"; // å ä½ç¬¦
        ctx.fillRect(player.x, player.y, player.w, player.h);
        ctx.fillStyle = "#000";
        ctx.fillText("HORSE", player.x + 5, player.y + 30);
    }
}

// ç»˜å›¾
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // ç”»èƒŒæ™¯ - ä½¿ç”¨beijing.pngå›¾ç‰‡
    if (bgImgLoaded) {
        // å¦‚æœå›¾ç‰‡å·²åŠ è½½ï¼Œä½¿ç”¨å›¾ç‰‡ç»˜åˆ¶èƒŒæ™¯
        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
    } else {
        // å¦‚æœå›¾ç‰‡æœªåŠ è½½ï¼Œä½¿ç”¨åŸæ¥çš„é¢œè‰²å¡«å……
        ctx.fillStyle = "#5c94fc"; // æ¸¸æˆå®¹å™¨èƒŒæ™¯è‰²
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // ç»˜åˆ¶äº‘æœµ
    drawClouds();

    // ç”»èƒŒæ™¯ (ç®€åŒ–ç‰ˆè®¾è®¡ç¨¿)
    // åœ°é¢éƒ¨åˆ† - ä½¿ç”¨zhuankuai.pngå›¾ç‰‡
    if (brickImgLoaded) {
        // å¦‚æœå›¾ç‰‡å·²åŠ è½½ï¼Œä½¿ç”¨å›¾ç‰‡ç»˜åˆ¶åœ°é¢
        ctx.drawImage(brickImg, 0, config.groundY, canvas.width, 80);
    } else {
        // å¦‚æœå›¾ç‰‡æœªåŠ è½½ï¼Œä½¿ç”¨åŸæ¥çš„é¢œè‰²å¡«å……
        ctx.fillStyle = "#228b22"; // åœ°é¢
        ctx.fillRect(0, config.groundY, canvas.width, 80);
    }
    
    // ç”»æ°´ç®¡ - ä½¿ç”¨guandao.pngå›¾ç‰‡
    if (pipeImgLoaded) {
        // å¦‚æœå›¾ç‰‡å·²åŠ è½½ï¼Œä½¿ç”¨å›¾ç‰‡ç»˜åˆ¶æ°´ç®¡
        ctx.drawImage(pipeImg, 40, 520, 60, 80);
    } else {
        // å¦‚æœå›¾ç‰‡æœªåŠ è½½ï¼Œä½¿ç”¨åŸæ¥çš„é¢œè‰²å¡«å……
        ctx.fillStyle = "#2e7d32";
        ctx.fillRect(40, 520, 60, 80);
    }

    // ç”»ç –å—
    blocks.forEach(b => {
        // ä¿å­˜å½“å‰ä¸Šä¸‹æ–‡çŠ¶æ€
        ctx.save();
        
        // è®¾ç½®é€æ˜åº¦æ¥åŒºåˆ†æ”¶é›†çŠ¶æ€
        ctx.globalAlpha = b.collected ? 0.5 : 1;
        
        // æ ¹æ®ç –å—ç±»å‹é€‰æ‹©å¯¹åº”çš„å›¾ç‰‡
        if (b.type === 'å‰' && jiImgLoaded) {
            // ä½¿ç”¨ji.pngå›¾ç‰‡ç»˜åˆ¶"å‰"å­—ç –å—
            ctx.drawImage(jiImg, b.x, b.y, 40, 40);
        } else if (b.type === 'ç¦' && fuImgLoaded) {
            // ä½¿ç”¨fu.pngå›¾ç‰‡ç»˜åˆ¶"ç¦"å­—ç –å—
            ctx.drawImage(fuImg, b.x, b.y, 40, 40);
        } else if (b.type === 'è´¢' && caiImgLoaded) {
            // ä½¿ç”¨cai.pngå›¾ç‰‡ç»˜åˆ¶"è´¢"å­—ç –å—
            ctx.drawImage(caiImg, b.x, b.y, 40, 40);
        } else if (b.type === 'æ—º' && wangImgLoaded) {
            // ä½¿ç”¨wang.pngå›¾ç‰‡ç»˜åˆ¶"æ—º"å­—ç –å—
            ctx.drawImage(wangImg, b.x, b.y, 40, 40);
        } else if (b.type === 'è¿' && yunImgLoaded) {
            // ä½¿ç”¨yun.pngå›¾ç‰‡ç»˜åˆ¶"è¿"å­—ç –å—
            ctx.drawImage(yunImg, b.x, b.y, 40, 40);
        } else if (b.type === 'é¡º' && shunImgLoaded) {
            // ä½¿ç”¨shun.pngå›¾ç‰‡ç»˜åˆ¶"é¡º"å­—ç –å—
            ctx.drawImage(shunImg, b.x, b.y, 40, 40);
        } else if (b.type === '' && dangezhuankuaiImgLoaded) {
            // ç©ºç™½è‰²å—ä½¿ç”¨dangezhuankuai.pngå›¾ç‰‡
            ctx.drawImage(dangezhuankuaiImg, b.x, b.y, 40, 40);
        } else {
            // å¦‚æœå›¾ç‰‡æœªåŠ è½½ï¼Œä½¿ç”¨é¢œè‰²å¡«å……å¹¶ä¿æŒå½¢çŠ¶
            ctx.fillStyle = "#ff9800"; // ä¿æŒåŸæ¥çš„é¢œè‰²ï¼Œé€šè¿‡é€æ˜åº¦æ¥åŒºåˆ†
            ctx.fillRect(b.x, b.y, 40, 40);
            
            // æ¢å¤é€æ˜åº¦ï¼Œç¡®ä¿æ–‡å­—æ˜¾ç¤ºæ­£å¸¸
            ctx.globalAlpha = 1;
            
            // åªç»˜åˆ¶æœ‰typeçš„ç –å—çš„æ–‡å­—
            if (b.type) {
                ctx.fillStyle = b.collected ? "#ffffff80" : "#fff"; // æ–‡å­—ä¹Ÿå˜æ·¡
                ctx.font = "16px Microsoft YaHei";
                ctx.textAlign = "center";
                ctx.fillText(b.type, b.x + 20, b.y + 25);
            }
        }
        
        // æ¢å¤é€æ˜åº¦ï¼Œç¡®ä¿ç‰©å“åç§°æ˜¾ç¤ºæ­£å¸¸
        ctx.globalAlpha = 1;
        
        // ç»˜åˆ¶ç‰©å“åç§°ï¼ˆæ”¶é›†åæ˜¾ç¤ºï¼‰
        if(b.collected && b.item) {
            // ç‰¹æ®Šå¤„ç†"æ©˜å­"å›¾ç‰‡
            if (b.item === 'æ©˜å­' && juziImgLoaded) {
                // è°ƒæ•´"æ©˜å­"å›¾ç‰‡å°ºå¯¸ä¸ºæ­£æ–¹å½¢ï¼Œé«˜åº¦æ¯”å®½åº¦å¤š1ä¸ªåƒç´ 
                const squareSize = 40; // æ­£æ–¹å½¢è¾¹é•¿
                const extraHeight = 1; // é¢å¤–é«˜åº¦
                const totalHeight = squareSize + extraHeight; // æ€»é«˜åº¦
                
                // è®¡ç®—ä½ç½®ä½¿å›¾ç‰‡åœ¨ç –å—ä¸Šæ–¹å±…ä¸­æ˜¾ç¤º
                const xPos = b.x; // ä¸ç –å—å·¦å¯¹é½
                const yPos = b.y - totalHeight - 5; // åœ¨ç –å—ä¸Šæ–¹5åƒç´ å¤„
                
                ctx.drawImage(juziImg, xPos, yPos, squareSize, totalHeight);
            } 
            // å¤„ç†"çº¢åŒ…"å›¾ç‰‡
            else if (b.item === 'çº¢åŒ…' && hongbaoImgLoaded) {
                // è°ƒæ•´"çº¢åŒ…"å›¾ç‰‡å°ºå¯¸ä¸ºæ­£æ–¹å½¢ï¼Œé«˜åº¦æ¯”å®½åº¦å¤š1ä¸ªåƒç´ 
                const squareSize = 40; // æ­£æ–¹å½¢è¾¹é•¿
                const extraHeight = 1; // é¢å¤–é«˜åº¦
                const totalHeight = squareSize + extraHeight; // æ€»é«˜åº¦
                
                // è®¡ç®—ä½ç½®ä½¿å›¾ç‰‡åœ¨ç –å—ä¸Šæ–¹å±…ä¸­æ˜¾ç¤º
                const xPos = b.x; // ä¸ç –å—å·¦å¯¹é½
                const yPos = b.y - totalHeight - 5; // åœ¨ç –å—ä¸Šæ–¹5åƒç´ å¤„
                
                ctx.drawImage(hongbaoImg, xPos, yPos, squareSize, totalHeight);
            }
            // å¤„ç†"é‡‘å…ƒå®"å›¾ç‰‡
            else if (b.item === 'é‡‘å…ƒå®' && yuanbaoImgLoaded) {
                // è°ƒæ•´"é‡‘å…ƒå®"å›¾ç‰‡å°ºå¯¸ä¸ºæ­£æ–¹å½¢ï¼Œé«˜åº¦æ¯”å®½åº¦å¤š1ä¸ªåƒç´ 
                const squareSize = 40; // æ­£æ–¹å½¢è¾¹é•¿
                const extraHeight = 1; // é¢å¤–é«˜åº¦
                const totalHeight = squareSize + extraHeight; // æ€»é«˜åº¦
                
                // è®¡ç®—ä½ç½®ä½¿å›¾ç‰‡åœ¨ç –å—ä¸Šæ–¹å±…ä¸­æ˜¾ç¤º
                const xPos = b.x; // ä¸ç –å—å·¦å¯¹é½
                const yPos = b.y - totalHeight - 5; // åœ¨ç –å—ä¸Šæ–¹5åƒç´ å¤„
                
                ctx.drawImage(yuanbaoImg, xPos, yPos, squareSize, totalHeight);
            }
            // å¤„ç†"ç‹—"å›¾ç‰‡
            else if (b.item === 'ç‹—' && dogImgLoaded) {
                // è°ƒæ•´"ç‹—"å›¾ç‰‡å°ºå¯¸ä¸ºæ­£æ–¹å½¢ï¼Œé«˜åº¦æ¯”å®½åº¦å¤š1ä¸ªåƒç´ 
                const squareSize = 40; // æ­£æ–¹å½¢è¾¹é•¿
                const extraHeight = 1; // é¢å¤–é«˜åº¦
                const totalHeight = squareSize + extraHeight; // æ€»é«˜åº¦
                
                // è®¡ç®—ä½ç½®ä½¿å›¾ç‰‡åœ¨ç –å—ä¸Šæ–¹å±…ä¸­æ˜¾ç¤º
                const xPos = b.x; // ä¸ç –å—å·¦å¯¹é½
                const yPos = b.y - totalHeight - 5; // åœ¨ç –å—ä¸Šæ–¹5åƒç´ å¤„
                
                ctx.drawImage(dogImg, xPos, yPos, squareSize, totalHeight);
            }
            // å¤„ç†"é±¼"å›¾ç‰‡
            else if (b.item === 'é±¼' && yuImgLoaded) {
                // è°ƒæ•´"é±¼"å›¾ç‰‡å°ºå¯¸ä¸ºæ­£æ–¹å½¢ï¼Œé«˜åº¦æ¯”å®½åº¦å¤š1ä¸ªåƒç´ 
                const squareSize = 40; // æ­£æ–¹å½¢è¾¹é•¿
                const extraHeight = 1; // é¢å¤–é«˜åº¦
                const totalHeight = squareSize + extraHeight; // æ€»é«˜åº¦
                
                // è®¡ç®—ä½ç½®ä½¿å›¾ç‰‡åœ¨ç –å—ä¸Šæ–¹å±…ä¸­æ˜¾ç¤º
                const xPos = b.x; // ä¸ç –å—å·¦å¯¹é½
                const yPos = b.y - totalHeight - 5; // åœ¨ç –å—ä¸Šæ–¹5åƒç´ å¤„
                
                ctx.drawImage(yuImg, xPos, yPos, squareSize, totalHeight);
            }
            // å¤„ç†"666"å›¾ç‰‡
            else if (b.item === '666' && liuliuImgLoaded) {
                // è°ƒæ•´"666"å›¾ç‰‡å°ºå¯¸ä¸ºæ­£æ–¹å½¢ï¼Œé«˜åº¦æ¯”å®½åº¦å¤š1ä¸ªåƒç´ 
                const squareSize = 40; // æ­£æ–¹å½¢è¾¹é•¿
                const extraHeight = 1; // é¢å¤–é«˜åº¦
                const totalHeight = squareSize + extraHeight; // æ€»é«˜åº¦
                
                // è®¡ç®—ä½ç½®ä½¿å›¾ç‰‡åœ¨ç –å—ä¸Šæ–¹å±…ä¸­æ˜¾ç¤º
                const xPos = b.x; // ä¸ç –å—å·¦å¯¹é½
                const yPos = b.y - totalHeight - 5; // åœ¨ç –å—ä¸Šæ–¹5åƒç´ å¤„
                
                ctx.drawImage(liuliuImg, xPos, yPos, squareSize, totalHeight);
            }
            else {
                // å…¶ä»–ç‰©å“ä»ç”¨æ–‡å­—æ˜¾ç¤º
                ctx.fillStyle = "#000";
                ctx.font = "12px Microsoft YaHei";
                ctx.textAlign = "center";
                ctx.fillText(b.item, b.x + 20, b.y - 5);
            }
        }
        
        // æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€
        ctx.restore();
    });

    // ç”»é‡‘å¸ - ä½¿ç”¨jinbi.pngå›¾ç‰‡
    coins.forEach(c => {
        if(!c.collected) {
            if (coinImgLoaded) {
                // å¦‚æœå›¾ç‰‡å·²åŠ è½½ï¼Œä½¿ç”¨å›¾ç‰‡ç»˜åˆ¶é‡‘å¸
                // é‡‘å¸å¤§å°è®¾ä¸º26x26åƒç´ ï¼Œä¸åŸæ¥çš„åœ†å½¢å¤§å°ç›¸è¿‘
                ctx.drawImage(coinImg, c.x - 8, c.y - 8, 26, 26);
            } else {
                // å¦‚æœå›¾ç‰‡æœªåŠ è½½ï¼Œä½¿ç”¨åŸæ¥çš„ç»˜åˆ¶æ–¹æ³•
                ctx.fillStyle = "#ffd700";
                ctx.beginPath();
                ctx.arc(c.x, c.y, 8, 0, Math.PI*2);
                ctx.fill();
            }
        }
    });

    // ç”»è˜‘è‡ (æ•Œäºº) - ä½¿ç”¨mogu.pngå›¾ç‰‡
    if (mushroomImgLoaded) {
        // å¦‚æœå›¾ç‰‡å·²åŠ è½½ï¼Œä½¿ç”¨å›¾ç‰‡ç»˜åˆ¶è˜‘è‡
        ctx.drawImage(mushroomImg, enemy.x, enemy.y, enemy.w, enemy.h);
    } else {
        // å¦‚æœå›¾ç‰‡æœªåŠ è½½ï¼Œä½¿ç”¨åŸæ¥çš„é¢œè‰²å¡«å……
        ctx.fillStyle = "#e57373";
        ctx.fillRect(enemy.x, enemy.y, enemy.w, enemy.h);
    }

    // ç”»ä¸»è§’ï¼ˆä½¿ç”¨æ–°çš„ç»˜åˆ¶å‡½æ•°ï¼‰
    drawPlayer();
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

// æ§åˆ¶é€»è¾‘
const keys = {};
window.addEventListener('keydown', e => {
    if(e.key === 'ArrowLeft') {
        player.vx = -config.speed;
        player.faceRight = false; // æœå·¦
    }
    if(e.key === 'ArrowRight') {
        player.vx = config.speed;
        player.faceRight = true; // æœå³
    }
    if(e.key === 'ArrowUp') {
        jump(); // è°ƒç”¨ç»Ÿä¸€çš„è·³è·ƒå‡½æ•°
    }
});
window.addEventListener('keyup', e => {
    if(e.key === 'ArrowLeft' || e.key === 'ArrowRight') player.vx = 0;
});

// ç»‘å®šæŒ‰é’®
document.getElementById('btn-left').ontouchstart = () => {
    player.vx = -config.speed;
    player.faceRight = false; // æœå·¦
};
document.getElementById('btn-right').ontouchstart = () => {
    player.vx = config.speed;
    player.faceRight = true; // æœå³
};
document.getElementById('btn-up').ontouchstart = () => {
    jump(); // è°ƒç”¨ç»Ÿä¸€çš„è·³è·ƒå‡½æ•°
};
document.body.ontouchend = () => player.vx = 0;

// åˆå§‹åŒ–æ¸¸æˆï¼ˆç¨ç­‰ç”¨æˆ·äº¤äº’ä»¥è§£å†³éŸ³é¢‘è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
document.addEventListener('click', function initOnFirstClick() {
    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œåªåˆå§‹åŒ–ä¸€æ¬¡
    document.removeEventListener('click', initOnFirstClick);
    // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’ï¼‰
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }
    initGame();
    loop();
}, { once: true });

// å¦‚æœç”¨æˆ·ç›´æ¥æŒ‰é”®ä¹Ÿè§¦å‘åˆå§‹åŒ–
document.addEventListener('keydown', function initOnFirstKeydown() {
    document.removeEventListener('keydown', initOnFirstKeydown);
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }
    initGame();
    loop();
}, { once: true });
</script>
</body>
</html>